                <html>
                  
                        <head>
                        
                            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
                      
                        </head>

                    <body>

                        <div class="container">
                        
                            <div class = "card">
                                <div class="card-header">
                                Live Chat
                                    </div>
                                    <div class="card-body">
                                <div  class  id="activelable" > 
                                    <h5   class="card-title" id="actives">Active Now:</h5> 
                                </div>
                            
                                <ul class="nav nav-tabs card-header-tabs" >
                                    <li id="messages" ></li>
                                        
                                    </ul>
                            <div class id="massegecard">
                                <br>
                            
                                <h5 class="card-title"> Add Message:</h5>
                                <input type="String" class="form-control" id="message" placeholder="Add Message here" >
                                <br>
                                <button class="btn btn-primary" onclick="sendMessage()" id="buttonsend">Submit</button>
                                <br>
                            </div>
                            <div class id="usernamecard">
                                <br>
                                <h5  class="card-title"> Add User Name:</h5>
                                <input  type="String"  class="form-control" id="username" placeholder="Add your username" >
                                <br>
                                <button class="btn btn-primary"  onclick="connect()"  id="buttonconnected">Connect</button>
                            </div>
                            </div>
                                
                                    </div>

                            </div>
                    
                                        <!-- <div class="mb-3">

                                            <div>
                                                <ul class="active-users" id="actives">
                            
                                                </ul>
                                            </div>

                                            <div>
                                                <ul class="list-group" id="messages">
                                                        
                                                </ul>
                                            </div>

                                            <br>
                                            <br>
                                            <label class="form-label" id="lablemessage">Add Message: </label>
                            <input type="String" class="form-control" id="message" >
                            
                            <form id="usernameform">
                            <label class="form-label" id="lableusername">Add User Name: </label>
                            <input type="String" class="form-control" id="username" >
                        </form>
                            </div>
                            <button class="btn btn-primary" onclick="sendMessage()" id="buttonsend">Submit</button>
                            <button class="btn btn-primary"  onclick="connect()"  id="buttonconnected">Connect</button>
                    
                        </div> -->
                    
                        <script>
                        
                            let m_webSocket = undefined;
                            let m_username = undefined;
                            displayElement("activelable");
                            displayElement("massegecard");
                            // document.getElementById("activelable").style.display= 'none';
                            // document.getElementById("massegecard").style.display= 'none';   
                            var input = document.getElementById("username");
                            useEnterKey(input, "buttonconnected");     

                            function connect() {
                                console.log('on connect');

                                const webSocket = new WebSocket("ws://localhost:8080");
                            
                
                                
                                webSocket.onopen = (event) => {
                                    if (m_webSocket) {
                                        m_webSocket.close();
                                        m_webSocket = undefined;
                                    }

                                    const username = document.getElementById("username").value; 

                                    const msg = {
                                        type: "username",
                                        senderUsername: username
                                    };

                                    m_username = username
                                    webSocket.send(JSON.stringify(msg))
                                    

                                    m_webSocket = webSocket;
                                    // document.getElementById("activelable").style.display= 'inline';
                            // document.getElementById("massegecard").style.display= 'inline';
                            // document.getElementById("usernamecard").style.display= 'none';
                            displayElement("activelable", false);
                            displayElement("massegecard", false);
                            displayElement("usernamecard");
                                        


                            var inputmsg = document.getElementById("message");
                            useEnterKey(inputmsg, "buttonsend");

                                    // _appendMessageToList("Open connection");
                                };

                                
                                webSocket.onmessage = (event) => {
                                    console.log(event.data);
                                    const data = JSON.parse(event.data);
                                    const type = data.type;
                                    // _appendMessageToList(`Recive: ${event.data}`);
                                    if(type == 'activeusers'){
                                        const active = data.active;
                                        const connectedUserList = data.connectedUserList;
                                        _appendMessageToListUsers(`Active Now: ${connectedUserList}`);
                                        if(active){
                                            _appendMessageToList(`${data.username} Logged in`);
                                        }else{
                                            _appendMessageToList(`${data.username} Logged out`);
                                        }
                                    }
                                    if(type == 'message'){
                                        const sender = data.senderUsername;
                                        _appendMessageToList(`<b>${sender} : </b> ${data.message}`);
                                    }
                                    if(type == 'rejectusername'){
                                        const username = data.username;
                                        _appendMessageToList(`The username already exists / empty , please choose another one`);
                                        //test
                                        displayElement("activelable", false);
                                        displayElement("massegecard");
                                        displayElement("usernamecard", false);
                                        
                                        // document.getElementById("activelable").style.display= 'inline';
                                        // document.getElementById("massegecard").style.display= 'none'; 
                                        // document.getElementById("usernamecard").style.display= 'inline';  
                                        document.getElementById("username").value= '';  
                                    }
                                }

                                webSocket.onclose = (event) => {
                                    console.log('The connection has been closed successfully.');
                                    m_webSocket = undefined;
                                }

                                webSocket.onerror = (event) => {
                                    console.log('WebSocket error: ', event);
                                    m_webSocket = undefined;
                                }
                            

                            }

                            function sendMessage() {
                                if (m_webSocket) {
                                    const message = document.getElementById("message").value;
                                    console.log(`message: ${message}`);


                                    const msg = {
                                        type: "message",
                                        message: message
                                    };
                                    _appendMessageToList(`<b>You : </b> ${message} `);
                                    // _appendMessageToList('Send: ' + JSON.stringify(msg));

                                    m_webSocket.send(JSON.stringify(msg))
                                } else {
                                    console.warn("Websocket not connected");
                                }
                                document.getElementById("message").value = '';
                            }

                            function _appendMessageToList(message) {
                                const orig = document.getElementById("messages").innerHTML
                                document.getElementById("messages").innerHTML =  orig + `<li  class="list-group-item">${message}</li>` 
                            }

                            function _appendMessageToListUsers(message) {
                                document.getElementById("actives").innerHTML = `<br class="active-users">${message}</br>`
                            }

                            function useEnterKey(input, button) {
                                input.addEventListener("keypress", function(event) {
                            if (event.key === "Enter") {
                            event.preventDefault();
                            document.getElementById(`${button}`).click();
                            }
                                });                
                            }

                            function displayElement(id, none = true){

                                document.getElementById(id).style.display= none ? 'none'  : 'inline';  
                            }

                        </script>
                        </body>
                    </html>